language: php

php: 
  - 5.4

services:
   - mongodb

env:
  global:
    - APP_NAME=phpmongoheroku-prod-citest2
   # - MONGOLAB_URI=mongodb://localhost/test
    - secure: QEgxuZ/iS9QEbwrENk3JQIh8bmV29MJ0TJm83mn2nsLvfNOO/llPKbuXqVB1oJtPMUd2X3SDNjEQKXwvdzVIgaieYE+v3IITHwJwq/u/3aa/lPqWJe893d1IAKjkr310u7A9oWjfYBqlbDbLVY+566k8oGvg3rBiXYWjEKZknBSXBA40pYECRwmKPpG+1lWahTA9hESnMdw7GD20ZqPfbm2IJDWj8xnlZAjnsSPiwVyKepIkRl9zODXEKOnKdW418eUloK86kdHzWXW24vzS0TgBKjzJTfpPTPCZo1imhm7wp++7qSbILqsZS2llJ/i6ypNakjakQmHv+mYvhISd8w== 
     
before_install:
#  - source ~/.rvm/scripts/rvm && rvm use 2.0.0
  - which heroku || wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh

before_script: 
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - echo "extension=mongo.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini

script:
  - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage test.php

after_success:
  - test -f ~/.ssh/id_rsa.heroku || ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.heroku && heroku keys:add ~/.ssh/id_rsa.heroku
  - git remote -v | grep ^heroku || heroku git:remote --ssh-git --app $APP_NAME
  #- git push -f git@heroku.com:$APP_NAME.git master
  - git push -f heroku master
  
notifications:
  email: false
